<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Alphanumeric Warning Bulletins and Alerts</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Mono', monospace;
            color: white;
            background: #15221b;
        }
        body a {
            /* color: green; */
            color:#0c0;
        }
        body a:hover {
            color: greenyellow;
        }
        .title {
            margin-bottom: 0;
        }
        .subtitle {
            margin-top: 0;
            margin-bottom: 30px;
        }
        hr {
            border-top: 1px solid rgba(0, 0, 0, 0.75);
            border-right: 1px solid rgba(0, 0, 0, 0.75);
            border-bottom: 1px solid #074a2a;
            border-left: 1px solid #074a2a;
        }
        .flex-container {
            display: flex;
            flex-direction: row;
            /* flex-wrap: nowrap; */
            /* height: 100vh; */
        }
        .scanlines {
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,.1) 70%,
                rgba(0,0,0,.3)
            );
            background-size: 100% .2rem;
            position: absolute;
            pointer-events: none;
        }

        .terminal {
            color:#0d0;
            font-family:VT323,monospace;
            /* font-family:VT323,monospace; */
            font-size:1.4em;
            background: #001a00;
            border-radius: 10px;
            padding: 15px;
            text-shadow: 0 0.2rem 0.5rem #074a2a;
            position: relative;

            box-shadow: inset 0 0 100px 0 rgba(0,0,0,0.3);

            overflow-y: scroll;
            overflow-x: visible;
        }
        .terminal span::selection, .terminal li::selection {
            background-color:#0c0;
            text-shadow: none;
            color:black;
        }

        #terminal {
            margin-bottom:0;
            margin-top:0;

            min-width: 620px;
            min-height: 200px;

            width: 100%;
        }
        .caret {
            background-color:transparent;
            animation:blink 1s steps(1,start) infinite;
        }
        @keyframes blink{
           50%{background-color:#0d0;}
        }

        #messages {
            /* height: 600px; */
            /* overflow-y: scroll; */
            margin: 0;
            font-size: 1.2em;
            padding-left: 30px;
            margin-left: 10px;
            list-style: symbols(cyclic "*");
            width: 100%;
        }
        #messages li.sysmsg, #current_wmo_al {
            list-style: none;
            background-color:#0c0;
            text-shadow: none;
            color:black;
            text-align: center;
            box-shadow: 0 0 5px 0 #074a2a;
        }

        footer {
            text-align: center;
            padding-bottom: 20px;
        }
        .smaller {
            color: yellowgreen;
            font-size: 0.9em;
        }
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        .modal-content {
            padding: 20px 50px;
            margin: 30px auto;
            background: black;
            width: 600px;
            max-height: 80%;
            overflow-y: scroll;
            border: 1px solid #0c0;
            position: relative;
        }
        button, input {
            border: black 1px solid;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            color: black;
            font-weight: bold;
            background: #0c0;
            font-size: 1em;
        }
        button:hover, input:hover {
            background: yellowgreen;
        }
        button.close-x {
            /* padding: 30px; */
            font-size: 18px;
            position: absolute;
            border: none;
            top: 0;
            right: 0;
            /* background: none; */
            /* color: #0c0; */
            /* font-size: 3em; */
        }
    </style>
</head>
<body>
    <h1 class="title">Alphanumeric Warning Bulletins and Alerts</h1>
    <h3 class="subtitle">from Meteorological Service of Canada's live feed<a style="cursor: pointer; padding-left: 5px;" data-show="modal">[?]</a></h3>
    <input id="disconnect" type="button" value="Disconnect" />
    <input id="connect" type="button" value="Connect" />
    <hr />
    <div class="flex-container">
        <div id="terminal" class="terminal">
            <div id="current_wmo_al"></div>
            <span id="current_bulletin">Waiting... </span>
            <span class="caret">&nbsp;</span>
            <div class="scanlines"></div>
        </div>
        <ul id="messages" class="terminal">
            <div class="scanlines"></div>
        </ul>
    </div>
    <hr />
    <footer>
        <p>❤️ Many thanks to ECCC for making this data open and accessible to the public.</p>
        <p class="smaller">
            Copyright © 2022 <a href="https://www.justinbull.ca">Justin A. S. Bull</a></p>
        </p>
        <p class="smaller">
            Contains information licenced under the <a href="https://eccc-msc.github.io/open-data/licence/readme_en/">Data Server End-use Licence</a> of Environment and Climate Change Canada.<br />
            Data Source: <a href="https://eccc-msc.github.io/open-data/readme_en/">Environment and Climate Change Canada</a><br />
        </p>
    </footer>
    <div id="modal" hidden="true">
        <div class="modal-content">
            <button data-dismiss="modal" class="close-x">×</button>
            <h1>What is this?</h1>
            <p>A fun project thanks to the open data from Environment and Climate Change Canada's Meteorological Service of Canada.</p>
            <p>It connects to MSC Datamart AMQP live feed, listening to all alphanumeric meteoroligical bulletins.</p>
            <p>Occasionally it'll display the alerts we all know and love issued under the Common Alert Protocol (CAP). Y'know, the ones that can make your phone scream like an "<a href="https://en.wikipedia.org/wiki/Amber_alert">Amber Alert</a>" if there's a life-threatening storm.</p>
            <p>This is (basically) the same backend feed that powers other Canadian governmental departments and private institutions. What you see here is near instant from the issuing stations and can often beat sites like weather.ca or what gets pushed to your phone.</p>
            <p><button data-dismiss="modal">Ok, cool</button></p>
        </div>
    </div>
    <script>
        const modal_el = document.getElementById("modal");
        const close_modal_els = modal_el.querySelectorAll("*[data-dismiss='modal']");
        close_modal_els.forEach((element) => {
            element.onclick = (e) => {
                e.preventDefault();
                modal_el.hidden = true;
            }
        });
        const show_modal_els = document.querySelectorAll("*[data-show='modal']");
        show_modal_els.forEach((element) => {
            element.onclick = (e) => {
                e.preventDefault();
                modal_el.hidden = false;
            }
        });


        const humanReadyState = (ws) => {
            switch(ws.readyState) {
                case ws.CLOSED:
                    return 'CLOSED';
                case ws.CLOSING:
                    return 'CLOSING';
                case ws.CONNECTING:
                    return 'CONNECTING';
                case ws.OPEN:
                    return 'OPEN';
                default:
                    return '<Unknown>';
            }
        }

        const messages_ul_el = document.getElementById("messages");
        const current_wmo_al = document.getElementById("current_wmo_al");
        const current_bulletin_el = document.getElementById("current_bulletin");
        const terminal_el = document.getElementById("terminal");

        let slowTextTimeouts = [];

        const slowBulletinText = (ahl, text, speed = 30) => {
            slowTextTimeouts.forEach((timeout) => {
                clearTimeout(timeout);
            })
            slowTextTimeouts = [];
            current_wmo_al.innerText = `[${ahl}]`;
            current_bulletin_el.innerText = '';
            const lines = text.split(/\r?\n/);
            for(i = 0; i < lines.length; i++) {
                const myLine = lines[i];
                const timeout = setTimeout((line, isFirst) => {
                    const existingText = current_bulletin_el.innerText;
                    current_bulletin_el.innerText = `${existingText}${isFirst ? '' : '\n'}${line}`;
                    scrollBottom();
                }, speed * i, myLine, i === 0);
                slowTextTimeouts.push(timeout);
            }
        }

        const receiveMessage = (payload) => {
            const parsedPayload = JSON.parse(payload);
            const newListItem  = document.createElement("li");
            if (parsedPayload["sysmsg"]) {
                // newListItem.classList.add('sysmsg')
                newListItem.appendChild(document.createTextNode("[SYS] " + parsedPayload["sysmsg"]));
                // current_bulletin_el.innerText = `[SYSTEM MESSAGE] ${parsedPayload["sysmsg"]}`;
            } else {
                newListItem.appendChild(document.createTextNode(`[RECV] [${parsedPayload['routing_key']}] ${parsedPayload["message"]}`));
            }
            messages_ul_el.appendChild(newListItem);
            scrollBottom();
            if (parsedPayload["body"]) {
                const wmoAhl = parsedPayload["message"]
                    .split("/")
                    .slice(-1)[0]
                    .split("_")
                    .slice(0, 3)
                    .join(" ")
                slowBulletinText(wmoAhl, parsedPayload["body"]);
                // current_bulletin_el.innerText = parsedPayload["body"];
            }
        }

        const sysMessage = (messageStr) => {
            const newListItem  = document.createElement("li");
            newListItem.appendChild(document.createTextNode(`*${messageStr}*`));
            newListItem.classList.add('sysmsg');
            messages_ul_el.appendChild(newListItem);
            scrollBottom();
        }

        const disconnect_btn = document.getElementById("disconnect");
        disconnect_btn.onclick = (e) => {
            e.preventDefault();
            ws.close();
            current_bulletin_el.innerText = 'Waiting...';
        }
        const connect_btn = document.getElementById("connect");
        connect_btn.onclick = (e) => {
            e.preventDefault();
            if (ws.readyState == ws.CLOSED) {
                ws = connectToWs();
            } else {
                sysMessage(`Cannot connect. Websocket not closed: ${humanReadyState(ws)}`)
            }
        }


        const scrollBottom = () => {
            terminal_el.scrollTop = terminal_el.scrollHeight;
            messages_ul_el.scrollTop = messages_ul_el.scrollHeight;
        }

        const connectToWs = () => {
            const _ws = new WebSocket('ws://' + document.domain + ':' + location.port + '/ws');
            _ws.onopen = (event) => {
                sysMessage("Websocket opened!");
            }
            _ws.onclose = (event) => {
                sysMessage("Websocket closed!");
            }
            _ws.onerror = (event) => {
                sysMessage("Websocket error!");
                console.error(event);
            }
            _ws.onmessage = (event) => {
                receiveMessage(event.data);
            };
            return _ws;
        }
        let ws = connectToWs();
    </script>
</body>
</html>
